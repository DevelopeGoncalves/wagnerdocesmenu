<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDV - WAGNER Doces (v11.0 - Fidelidade Premium)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            chocolate: '#5D4037',      
            chocolateLight: '#8D6E63', 
            doceriaPink: '#D81B60',    
            doceriaCream: '#FFF3E0',   
            dark: '#2d2420',
            mpBlue: '#009EE3',
            gold: '#FFD700',
            silver: '#C0C0C0',
            bronze: '#CD7F32',
            diamond: '#B9F2FF'
          },
          animation: {
            'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>

  <style>
    /* LAYOUT E SCROLL */
    html, body, #root { 
        height: 100%; margin: 0; padding: 0; overflow: hidden; 
        background-color: #fdfbf7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .app-container {
        height: 100vh; display: flex; flex-direction: row; overflow: hidden;
    }

    .main-content-area {
        flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden;
    }

    .scrollable-content {
        flex: 1; overflow-y: auto; padding-bottom: 40px;
    }

    /* SCROLLBAR PERSONALIZADA */
    ::-webkit-scrollbar { width:8px; height:8px; }
    ::-webkit-scrollbar-thumb { background: #8D6E63; border-radius:999px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* KPI CARDS */
    .kpi-card {
        padding: 1.5rem; border-radius: 1rem; color: white; position: relative;
        overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-2px); }
    .kpi-value { font-size: 1.8rem; font-weight: 800; }
    .kpi-label { font-size: 0.8rem; opacity: 0.9; text-transform: uppercase; font-weight: bold; letter-spacing: 0.05em; }

    /* CUPOM DE IMPRESS√ÉO */
    @media print {
      body * { visibility: hidden; }
      #cupom-imprecao, #cupom-imprecao * { visibility: visible; }
      #cupom-imprecao { position: fixed; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
      @page { margin: 0; size: auto; }
    }
  </style>
</head>
<body class="bg-slate-50">

  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo, useRef } = React;

  /*************************************************
   * CONFIGURA√á√ÉO VISUAL PROFISSIONAL (CHARTS)
   *************************************************/
  
  const CORES = {
      primary: '#5D4037',     
      secondary: '#D81B60',   
      accent: '#FFB74D',      
      success: '#43A047',     
      info: '#26C6DA',        
      neutral: '#8D6E63',     
      light: '#FFF3E0',       
      palette: [
          '#5D4037', '#D81B60', '#FBC02D', '#00ACC1', '#8E24AA', '#FB8C00', '#558B2F'
      ]
  };

  Chart.register(ChartDataLabels);
  Chart.defaults.font.family = "'Segoe UI', sans-serif";
  Chart.defaults.color = '#5D4037';

  function ChartComponent({ type, data, options }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);
      
      useEffect(() => {
          if (!canvasRef.current) return;
          if (chartRef.current) chartRef.current.destroy();

          const defaultOptions = {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { 
                      position: 'bottom',
                      labels: { usePointStyle: true, padding: 20, font: { size: 11, weight: 'bold' } }
                  },
                  datalabels: {
                      display: true, 
                      color: '#fff',
                      font: { weight: 'bold', size: 11 },
                      formatter: (value) => {
                          if(typeof value === 'number' && value > 100) return 'R$ ' + value.toFixed(0);
                          return value;
                      },
                      anchor: 'end',
                      align: 'start',
                      offset: -4,
                      backgroundColor: (context) => context.dataset.backgroundColor,
                      borderRadius: 4,
                      padding: 4
                  }
              }
          };

          const finalOptions = { ...defaultOptions, ...options };
          if(options?.plugins) finalOptions.plugins = { ...defaultOptions.plugins, ...options.plugins };

          chartRef.current = new Chart(canvasRef.current, { 
              type, data, options: finalOptions, plugins: [ChartDataLabels] 
          });
          
          return () => { if (chartRef.current) chartRef.current.destroy(); }
      }, [data, options, type]);

      return <canvas ref={canvasRef} />;
  }

  /*************************************************
   * UTILIT√ÅRIOS E STORAGE
   *************************************************/

  function uid(){ return Date.now() + Math.floor(Math.random()*9999); }
  function currency(v){ return 'R$ ' + Number(v||0).toFixed(2).replace('.', ','); }
  
  function storageGet(key, fallback=null){ 
    try {
      const data = localStorage.getItem('WAGNER_doceria_v10_' + key); 
      return data ? JSON.parse(data) : fallback;
    } catch(e){ return fallback; }
  }

  function storageSet(key, value){ 
    try { localStorage.setItem('WAGNER_doceria_v10_' + key, JSON.stringify(value)); } catch(e){}
  }

  /* ================= EXPORTA√á√ÉO CONT√ÅBIL AVAN√áADA ================= */
  /* ================= EXPORTA√á√ÉO CONT√ÅBIL OTIMIZADA ================= */
  /* Substitua a fun√ß√£o antiga por esta */
  function gerarCSVContabil(vendas, dataInicio, dataFim) {
    if(!vendas || !vendas.length) return alert("Sem dados para exportar.");
    
    // Garante que pega o dia inteiro (00:00 at√© 23:59)
    const inicio = new Date(dataInicio + 'T00:00:00');
    const fim = new Date(dataFim + 'T23:59:59');
    
    const vendasFiltradas = vendas.filter(v => {
        const d = new Date(v.data);
        return d >= inicio && d <= fim;
    });

    if(vendasFiltradas.length === 0) return alert("Nenhuma venda encontrada no per√≠odo selecionado.");

    // NOVO CABE√áALHO: Colunas separadas para facilitar o c√°lculo do imposto
    let csvContent = "\uFEFFID Venda;Data;Hora;Loja;Cliente;Meio Pagamento;Total Venda (R$);Venda Tributada (Pr√≥pria);Venda Revenda (ST/Isento);Itens Detalhados\n";

    vendasFiltradas.forEach(v => {
        const d = new Date(v.data);
        const dataStr = d.toLocaleDateString('pt-BR');
        const horaStr = d.toLocaleTimeString('pt-BR');
        
        let totalTributado = 0;
        let totalRevenda = 0;

        // L√ìGICA FISCAL AUTOM√ÅTICA
        const resumoItens = v.itens.map(i => {
            const qtd = i.quantidade || 1;
            const precoUnit = i.preco || 0;
            const totalItem = precoUnit * qtd;

            // REGRA: Se a categoria for 'Bebidas' ou o nome tiver palavras chave de revenda,
            // classifica como Substitui√ß√£o Tribut√°ria (ST) para abater imposto.
            const nomeLower = (i.nome || '').toLowerCase();
            const catLower = (i.categoria || '').toLowerCase();
            
            const isRevenda = catLower === 'bebidas' || 
                              nomeLower.includes('√°gua') || 
                              nomeLower.includes('agua') || 
                              nomeLower.includes('refrigerante') || 
                              nomeLower.includes('coca') || 
                              nomeLower.includes('guaran√°') ||
                              nomeLower.includes('lata') ||
                              nomeLower.includes('suco');

            if(isRevenda) {
                totalRevenda += totalItem;
            } else {
                totalTributado += totalItem;
            }

            return `${qtd}x ${i.nome}`;
        }).join(" | ");

        // Ajuste fino de centavos (se houver diferen√ßa de arredondamento, joga no tributado)
        const somaItens = totalTributado + totalRevenda;
        if(Math.abs(v.total - somaItens) > 0.01) {
            totalTributado = v.total - totalRevenda; 
        }

        // Formata√ß√£o num√©rica padr√£o PT-BR (v√≠rgula)
        const f = (n) => Number(n).toFixed(2).replace('.', ',');

        const linha = [
            v.id.toString().slice(-8), // ID resumido
            dataStr,
            horaStr,
            v.loja || 'Matriz',
            v.clienteId ? 'Cliente Cadastrado' : 'Consumidor Final',
            v.metodo,
            f(v.total),       // Coluna G: Total
            f(totalTributado), // Coluna H: O que voc√™ paga imposto cheio
            f(totalRevenda),   // Coluna I: O que j√° tem imposto pago (ST)
            resumoItens
        ].join(";");

        csvContent += linha + "\n";
    });

    // Gera o arquivo para Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    // Nome do arquivo padronizado para o contador n√£o se perder
    link.setAttribute("download", `RELATORIO_FISCAL_PDV_${dataInicio}_a_${dataFim}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  /**********************
   * DADOS INICIAIS
   **********************/
  const initialProducts = [
    { id: 1, nome: 'Brigadeiro Tradicional', preco: 3.50, custo: 1.20, emoji: 'üç´', categoria: 'Tradicionais', estoque: { morada: 50, novoHorizonte: 30 }, limiteAlerta: 20 },
    { id: 2, nome: 'Beijinho', preco: 3.50, custo: 1.10, emoji: 'ü••', categoria: 'Tradicionais', estoque: { morada: 45, novoHorizonte: 25 }, limiteAlerta: 20 },
    { id: 3, nome: 'Ninho com Nutella', preco: 5.50, custo: 2.50, emoji: 'üç¨', categoria: 'Gourmet', estoque: { morada: 30, novoHorizonte: 10 }, limiteAlerta: 10 },
    { id: 4, nome: 'Brigadeiro de Nozes', preco: 5.50, custo: 2.30, emoji: 'üå∞', categoria: 'Gourmet', estoque: { morada: 20, novoHorizonte: 5 }, limiteAlerta: 10 },
    { id: 5, nome: 'Bombom de Morango', preco: 7.50, custo: 3.50, emoji: 'üçì', categoria: 'Bombons', estoque: { morada: 15, novoHorizonte: 8 }, limiteAlerta: 5 },
    { id: 6, nome: '√Ågua Mineral', preco: 4.00, custo: 1.50, emoji: 'üíß', categoria: 'Bebidas', estoque: { morada: 100, novoHorizonte: 60 }, limiteAlerta: 24 },
  ];
  
  const initialClients = [
      { id: 101, nome: 'Maria Silva', telefone: '27 99999-0000', saldoPontos: 150, totalAcumulado: 450, nivel: 'Prata', historico: [] },
      { id: 102, nome: 'Jo√£o Santos', telefone: '27 98888-1111', saldoPontos: 45, totalAcumulado: 45, nivel: 'Bronze', historico: [] },
  ];

  /* ================= VIEWS DO SISTEMA ================= */

  function DashboardView({ vendas, produtos }) {
      const [abaAtiva, setAbaAtiva] = useState('Geral');
      const hoje = new Date().toLocaleDateString('pt-BR');
      const mesAtual = new Date().getMonth();

      const vendasFiltradas = vendas.filter(v => {
          if (abaAtiva === 'Geral') return true;
          return v.loja === abaAtiva;
      });

      const vendasHoje = vendasFiltradas.filter(v => new Date(v.data).toLocaleDateString('pt-BR') === hoje);
      const vendasMes = vendasFiltradas.filter(v => new Date(v.data).getMonth() === mesAtual);

      const faturamentoHoje = vendasHoje.reduce((a,b) => a + b.total, 0);
      const faturamentoMes = vendasMes.reduce((a,b) => a + b.total, 0);
      
      const chartPagamentosData = useMemo(() => {
          const counts = { 'Dinheiro':0, 'Pix':0, 'Cr√©dito':0, 'D√©bito':0 };
          vendasFiltradas.forEach(v => {
              const m = v.metodo || 'Dinheiro';
              if(counts[m] !== undefined) counts[m] += v.total;
          });
          return {
              labels: Object.keys(counts),
              datasets: [{ data: Object.values(counts), backgroundColor: CORES.palette }]
          };
      }, [vendasFiltradas]);

      const lowStockMorada = produtos.filter(p => p.estoque.morada < (p.limiteAlerta || 15));
      const lowStockNH = produtos.filter(p => p.estoque.novoHorizonte < (p.limiteAlerta || 15));

      return (
          <div className="p-6">
              <div className="flex flex-col md:flex-row justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-chocolate">üìä Painel {abaAtiva}</h2>
                  <div className="bg-white p-1 rounded-xl shadow border border-gray-200 flex mt-4 md:mt-0">
                    <button onClick={()=>setAbaAtiva('Geral')} className={`px-4 py-2 rounded-lg font-bold transition ${abaAtiva==='Geral' ? 'bg-chocolate text-white' : 'text-gray-500 hover:bg-gray-100'}`}>Geral</button>
                    <button onClick={()=>setAbaAtiva('Morada')} className={`px-4 py-2 rounded-lg font-bold transition ${abaAtiva==='Morada' ? 'bg-doceriaPink text-white' : 'text-gray-500 hover:bg-gray-100'}`}>Morada</button>
                    <button onClick={()=>setAbaAtiva('Novo Horizonte')} className={`px-4 py-2 rounded-lg font-bold transition ${abaAtiva==='Novo Horizonte' ? 'bg-blue-600 text-white' : 'text-gray-500 hover:bg-gray-100'}`}>Novo Horizonte</button>
                  </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div className="kpi-card bg-gradient-to-br from-blue-600 to-blue-800">
                      <div className="kpi-label">Vendas Hoje</div>
                      <div className="kpi-value">{currency(faturamentoHoje)}</div>
                  </div>
                  <div className="kpi-card bg-gradient-to-br from-doceriaPink to-pink-700">
                      <div className="kpi-label">Faturamento M√™s</div>
                      <div className="kpi-value">{currency(faturamentoMes)}</div>
                  </div>
                  <div className="kpi-card bg-gradient-to-br from-chocolate to-gray-900">
                      <div className="kpi-label">Pedidos Hoje</div>
                      <div className="kpi-value">{vendasHoje.length}</div>
                  </div>
              </div>

              <h3 className="text-xl font-bold text-chocolate mb-4 flex items-center gap-2">‚ö†Ô∏è Alertas de Estoque Baixo</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                  <div className="bg-white p-5 rounded-2xl shadow border-l-8 border-l-doceriaPink">
                      <h4 className="font-bold text-lg text-gray-700 mb-3 border-b pb-2">üè† Loja Morada</h4>
                      <div className="space-y-2 max-h-[200px] overflow-y-auto pr-2">
                        {lowStockMorada.length === 0 ? <p className="text-green-600 font-bold text-sm">Estoque saud√°vel! ‚úÖ</p> : 
                           lowStockMorada.map(p => (
                               <div key={p.id} className="flex justify-between items-center text-sm p-2 bg-red-50 rounded text-red-800">
                                   <div className="flex flex-col">
                                     <span className="font-bold">{p.emoji} {p.nome}</span>
                                     <span className="text-[10px] text-red-400">Min: {p.limiteAlerta || 15}</span>
                                   </div>
                                   <span className="font-bold bg-white px-2 py-1 rounded shadow-sm text-red-600">{p.estoque.morada} un.</span>
                               </div>
                           ))
                        }
                      </div>
                  </div>

                  <div className="bg-white p-5 rounded-2xl shadow border-l-8 border-l-blue-600">
                      <h4 className="font-bold text-lg text-gray-700 mb-3 border-b pb-2">üåÖ Loja Novo Horizonte</h4>
                      <div className="space-y-2 max-h-[200px] overflow-y-auto pr-2">
                        {lowStockNH.length === 0 ? <p className="text-green-600 font-bold text-sm">Estoque saud√°vel! ‚úÖ</p> : 
                           lowStockNH.map(p => (
                               <div key={p.id} className="flex justify-between items-center text-sm p-2 bg-red-50 rounded text-red-800">
                                   <div className="flex flex-col">
                                     <span className="font-bold">{p.emoji} {p.nome}</span>
                                     <span className="text-[10px] text-red-400">Min: {p.limiteAlerta || 15}</span>
                                   </div>
                                   <span className="font-bold bg-white px-2 py-1 rounded shadow-sm text-red-600">{p.estoque.novoHorizonte} un.</span>
                               </div>
                           ))
                        }
                      </div>
                  </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                  <div className="bg-white p-6 rounded-2xl shadow border border-gray-100">
                      <h3 className="font-bold text-chocolate mb-4">üí∞ Vendas por M√©todo</h3>
                      <div style={{ height: '250px' }} className="flex justify-center">
                          <ChartComponent type="doughnut" data={chartPagamentosData} options={{ responsive: true, maintainAspectRatio: false }} />
                      </div>
                  </div>
                  <div className="bg-white p-6 rounded-2xl shadow border border-gray-100">
                      <h3 className="font-bold text-gray-700 mb-4">üìù √öltimas Vendas</h3>
                      <div className="overflow-x-auto max-h-[250px] overflow-y-auto">
                          <table className="w-full text-sm text-left">
                              <tbody>
                                  {vendasFiltradas.slice().reverse().slice(0, 8).map(v => (
                                      <tr key={v.id} className="border-b last:border-0 hover:bg-gray-50">
                                          <td className="px-4 py-3 text-gray-500 text-xs">{new Date(v.data).toLocaleTimeString().slice(0,5)}</td>
                                          <td className="px-4 py-3 font-bold text-gray-700">{v.loja}</td>
                                          <td className="px-4 py-3"><span className="bg-gray-100 px-2 py-1 rounded text-xs">{v.metodo}</span></td>
                                          <td className="px-4 py-3 text-right font-bold text-chocolate">{currency(v.total)}</td>
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          </div>
      );
  }

  function BIView({ vendas, produtos }) {
    const dadosGerais = useMemo(() => {
        const hoje = new Date();
        const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        
        const labels7Dias = [];
        const dataVendas7Dias = [];
        for(let i=6; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const dateStr = d.toLocaleDateString('pt-BR').slice(0,5);
            labels7Dias.push(dateStr);
            const total = vendas.filter(v => new Date(v.data).toLocaleDateString('pt-BR').slice(0,5) === dateStr)
                                .reduce((acc, v) => acc + v.total, 0);
            dataVendas7Dias.push(total);
        }

        const catCount = {};
        vendas.forEach(v => {
            v.itens.forEach(item => {
                const prodReal = produtos.find(p => p.id === item.id);
                const cat = prodReal ? prodReal.categoria : 'Outros';
                catCount[cat] = (catCount[cat] || 0) + (item.preco * item.quantidade); 
            });
        });
        
        const semanaCount = [0,0,0,0,0,0,0];
        vendas.forEach(v => {
            const dia = new Date(v.data).getDay();
            semanaCount[dia] += v.total;
        });

        const horasCount = Array(24).fill(0);
        vendas.forEach(v => { horasCount[new Date(v.data).getHours()] += 1; });
        const horasLabels = []; const horasData = [];
        horasCount.forEach((qtd, hora) => {
            if(qtd > 0) { horasLabels.push(`${hora}h`); horasData.push(qtd); }
        });

        return {
            evolucao: {
                labels: labels7Dias,
                datasets: [{
                    label: 'Faturamento (R$)', data: dataVendas7Dias,
                    borderColor: CORES.secondary, backgroundColor: 'rgba(216, 27, 96, 0.1)',
                    borderWidth: 3, tension: 0.4, fill: true, pointBackgroundColor: '#fff', pointRadius: 6
                }]
            },
            categorias: {
                labels: Object.keys(catCount),
                datasets: [{ data: Object.values(catCount), backgroundColor: CORES.palette, borderWidth: 0, hoverOffset: 10 }]
            },
            semana: {
                labels: diasSemana,
                datasets: [{
                    label: 'Vendas Totais (R$)', data: semanaCount,
                    backgroundColor: diasSemana.map((d, i) => i === hoje.getDay() ? CORES.secondary : CORES.neutral),
                    borderRadius: 6
                }]
            },
            horarios: {
                labels: horasLabels,
                datasets: [{
                    label: 'Qtd. Pedidos', data: horasData,
                    backgroundColor: CORES.accent, borderRadius: 4, barPercentage: 0.6
                }]
            }
        };
    }, [vendas, produtos]);

    return (
        <div className="p-6 pb-20">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-chocolate flex items-center gap-2"><span className="text-3xl">üìà</span> Business Intelligence</h2>
                <div className="text-sm text-gray-500 font-medium bg-white px-3 py-1 rounded-lg border shadow-sm">Atualizado em tempo real</div>
            </div>

            <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 mb-8 relative overflow-hidden">
                <div className="absolute top-0 left-0 w-2 h-full bg-doceriaPink"></div>
                <h3 className="font-bold text-gray-700 mb-6 flex items-center gap-2">üíµ Evolu√ß√£o do Faturamento (7 Dias)</h3>
                <div style={{ height: '320px' }}>
                    <ChartComponent type="line" data={dadosGerais.evolucao} options={{ plugins: { datalabels: { display: false }, legend: { display: false } }, scales: { y: { grid: { color: '#f0f0f0' }, ticks: { callback: (v) => 'R$ ' + v } }, x: { grid: { display: false } } } }} />
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-white p-6 rounded-2xl shadow-md border border-gray-100">
                    <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">üç∞ Faturamento por Categoria</h3>
                    <div className="h-[300px] flex justify-center">
                        <ChartComponent type="doughnut" data={dadosGerais.categorias} options={{ layout: { padding: 20 }, plugins: { legend: { position: 'right' }, datalabels: { color: '#fff', font: { weight: 'bold', size: 11 }, formatter: (val) => 'R$ ' + val.toFixed(0) } } }} />
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-md border border-gray-100">
                    <h3 className="font-bold text-gray-700 mb-4">üìÖ Performance Semanal</h3>
                    <div className="h-[300px]">
                        <ChartComponent type="bar" data={dadosGerais.semana} options={{ plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', color: CORES.primary, formatter: (val) => val > 0 ? 'R$ ' + val : '' } }, scales: { y: { display: false }, x: { grid: { display: false } } } }} />
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-md border border-gray-100 lg:col-span-2">
                    <h3 className="font-bold text-gray-700 mb-4">‚è∞ Hor√°rios de Pico (Qtd. Pedidos)</h3>
                    <div className="h-[250px]">
                        <ChartComponent type="bar" data={dadosGerais.horarios} options={{ indexAxis: 'x', plugins: { legend: { display: false }, datalabels: { color: '#fff', anchor: 'center', align: 'center' } } }} />
                    </div>
                </div>
            </div>
        </div>
    );
  }

  function PDVView({ produtos, carrinho, setCarrinho, finalizarVenda, clientes, user }){ // <--- Note que adicionei 'user' aqui
    const [busca, setBusca] = useState('');
    const [cat, setCat] = useState('Todos');
    const [clienteSelecionado, setClienteSelecionado] = useState('');
    
    // SE FOR ADMIN, PODE TROCAR. SE FOR CAIXA, TRAVA NA LOJA DO LOGIN.
    const [lojaAtiva, setLojaAtiva] = useState(user.role === 'admin' ? 'Morada' : user.store);
    
    const [modalPagamento, setModalPagamento] = useState(false);
    
    // --- ESTADOS DA MAQUININHA (INTEGRA√á√ÉO V10) ---
    const [mpStatus, setMpStatus] = useState('idle'); 
    const [mpMessage, setMpMessage] = useState('');
    const [configMP, setConfigMP] = useState(null);

    useEffect(() => {
        // Garante que se o usu√°rio mudar, a loja reseta para a correta
        if(user.role !== 'admin') setLojaAtiva(user.store);
        
        const key = lojaAtiva === 'Morada' ? 'mp_config_Morada' : 'mp_config_NH';
        setConfigMP(storageGet(key, null));
    }, [lojaAtiva, user]);
    
    // ... RESTO DO C√ìDIGO DO PDV (Mantenha igual, s√≥ cuidado onde tem o <select> de loja abaixo)

    const categorias = ['Todos', ...new Set(produtos.map(p => p.categoria))];
    const filtrados = produtos.filter(p => {
        return p.nome.toLowerCase().includes(busca.toLowerCase()) && (cat === 'Todos' || p.categoria === cat);
    });

    function getEstoque(p) { return lojaAtiva === 'Morada' ? p.estoque.morada : p.estoque.novoHorizonte; }

    function add(p) {
        const est = getEstoque(p);
        const itemCarrinho = carrinho.find(i => i.id === p.id);
        const qtdCarrinho = itemCarrinho ? itemCarrinho.quantidade : 0;
        
        if((est - qtdCarrinho) <= 0) {
            if(!confirm(`Estoque zerado na loja ${lojaAtiva}. Continuar mesmo assim?`)) return;
        }
        
        if(itemCarrinho) setCarrinho(carrinho.map(i => i.id===p.id ? {...i, quantidade: i.quantidade+1} : i));
        else setCarrinho([...carrinho, {...p, quantidade:1}]);
    }
    
    function remove(id) { setCarrinho(carrinho.filter(i => i.id !== id)); }
    const total = carrinho.reduce((a, b) => a + (b.preco * b.quantidade), 0);

    // --- FUN√á√ÉO DE PROCESSAMENTO DE CART√ÉO (POINT SMART) ---
    async function processarPagamentoCartao(tipo) {
        if(!configMP || !configMP.deviceId || !configMP.apiUrl) {
            alert(`ERRO: Maquininha n√£o configurada para loja ${lojaAtiva}! V√° em 'Config. Maquininha'.`);
            return;
        }

        setMpStatus('processing');
        setMpMessage('Conectando √† Point Smart...');

        try {
            // Chamada para o BACKEND (Supabase) - Vai falhar se n√£o configurar, mas o c√≥digo est√° aqui
            const response = await fetch(configMP.apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: total,
                    device_id: configMP.deviceId,
                    description: `Pedido ${uid()} - ${lojaAtiva}`
                })
            });

            const data = await response.json();

            if(!response.ok) throw new Error(data.error || 'Erro na comunica√ß√£o');

            setMpMessage('Aguardando senha na maquininha...');
            
            // SIMULA√á√ÉO DE ESPERA (POLLING)
            setTimeout(() => {
                setMpStatus('success');
                setMpMessage('Pagamento Aprovado!');
                setTimeout(() => {
                    finalizarVenda(total, clienteSelecionado, lojaAtiva, tipo);
                    setModalPagamento(false);
                    setMpStatus('idle');
                }, 2000);
            }, 5000); 

        } catch (error) {
            setMpStatus('error');
            setMpMessage('Erro na Nuvem: ' + error.message + ' (Verifique se a API do Supabase est√° rodando)');
        }
    }

    return (
      <div className="flex flex-col h-full p-4 gap-4 md:flex-row pb-20">
        <div className="flex-1 flex flex-col gap-4 overflow-hidden">
            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-4 justify-between items-center">
                {/* Seletor de Loja (Travado se n√£o for Admin) */}
                <div className="w-full md:w-auto">
                    <label className="text-xs font-bold uppercase text-gray-500 mb-1">Loja Ativa</label>
                    {user.role === 'admin' ? (
                        <select value={lojaAtiva} onChange={e => { setLojaAtiva(e.target.value); setCarrinho([]); }} className="w-full p-2 border-2 border-doceriaPink rounded-lg font-bold text-chocolate bg-pink-50">
                            <option value="Morada">üè† Morada</option>
                            <option value="Novo Horizonte">üåÖ Novo Horizonte</option>
                        </select>
                    ) : (
                        <div className="w-full p-2 border-2 border-gray-200 rounded-lg font-bold text-gray-500 bg-gray-100 flex items-center gap-2">
                            <span>üîí</span> {lojaAtiva}
                        </div>
                    )}
                </div>
                <div className="flex-1 w-full relative">
                    <input value={busca} onChange={e=>setBusca(e.target.value)} placeholder="üîç Buscar doce..." className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-doceriaPink" />
                </div>
                <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                    {categorias.map(c => (<button key={c} onClick={()=>setCat(c)} className={`px-4 py-1 rounded-full text-sm font-medium whitespace-nowrap transition ${cat===c ? 'bg-chocolate text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{c}</button>))}
                </div>
            </div>

            <div className="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 content-start pr-1">
                {filtrados.map(p => {
                    const est = getEstoque(p);
                    const limite = p.limiteAlerta || 15;
                    return (
                        <div key={p.id} onClick={()=>add(p)} className={`relative bg-white p-3 rounded-2xl shadow-sm border cursor-pointer hover:shadow-md transition flex flex-col items-center text-center ${est <= 0 ? 'border-red-300 opacity-70' : 'border-gray-100 hover:border-doceriaPink'}`}>
                            {est <= 0 && <div className="absolute top-2 right-2 text-xs font-bold text-red-500 bg-red-100 px-1 rounded">0</div>}
                            <div className="text-4xl mb-2">{p.emoji}</div>
                            <div className="font-bold text-chocolate text-sm leading-tight mb-1">{p.nome}</div>
                            <div className="text-doceriaPink font-bold">{currency(p.preco)}</div>
                            <div className={`text-xs mt-1 font-bold ${est < limite ? 'text-red-500' : 'text-gray-400'}`}>Est: {est}</div>
                        </div>
                    );
                })}
            </div>
        </div>

        <div className="w-full md:w-96 bg-white rounded-2xl shadow-xl border border-gray-200 flex flex-col h-[calc(100vh-100px)] md:h-auto">
            <div className="p-4 border-b bg-chocolate text-white rounded-t-2xl flex justify-between items-center">
                <div><h3 className="font-bold text-lg">Cupom Fiscal</h3><span className="text-xs opacity-80">{lojaAtiva}</span></div>
                <span className="text-xs bg-white/20 px-2 py-1 rounded">{carrinho.length} it.</span>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                {carrinho.length === 0 && <div className="text-center text-gray-400 mt-10">Carrinho vazio üç∞</div>}
                {carrinho.map(item => (
                    <div key={item.id} className="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                        <div><div className="font-bold text-sm text-gray-800">{item.nome}</div><div className="text-xs text-gray-500">{item.quantidade}x {currency(item.preco)}</div></div>
                        <div className="flex items-center gap-2"><div className="font-bold text-chocolate">{currency(item.preco * item.quantidade)}</div><button onClick={()=>remove(item.id)} className="text-red-400 font-bold px-2">X</button></div>
                    </div>
                ))}
            </div>
            
            <div className="p-5 bg-gray-50 rounded-b-2xl border-t space-y-3">
                <select value={clienteSelecionado} onChange={(e) => setClienteSelecionado(e.target.value)} className="w-full p-2 bg-white border rounded text-sm outline-none text-gray-700">
                    <option value="">Cliente Avulso</option>
                    {clientes.map(c => (<option key={c.id} value={c.id}>{c.nome} (Saldo: {c.saldoPontos})</option>))}
                </select>

                <div className="flex justify-between items-end"><span className="text-gray-500">Total a pagar</span><span className="text-3xl font-bold text-chocolate">{currency(total)}</span></div>
                
                <div className={`text-xs text-center p-1 rounded ${configMP?.deviceId ? 'text-green-600 bg-green-100' : 'text-red-500 bg-red-100'}`}>
                    {configMP?.deviceId ? 'üì° Point Smart Conectada' : 'üîå Configure a Maquininha'}
                </div>

                <button onClick={()=>setModalPagamento(true)} disabled={carrinho.length===0} className="w-full py-4 bg-doceriaPink text-white font-bold rounded-xl shadow hover:bg-pink-600 disabled:opacity-50 transition transform active:scale-95">PAGAMENTO</button>
            </div>
        </div>

        {/* MODAL DE PAGAMENTO INTELIGENTE */}
        {modalPagamento && (
            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative overflow-hidden">
                    
                    {mpStatus === 'idle' && (
                        <>
                            <h3 className="text-xl font-bold text-chocolate mb-4 text-center">Forma de Pagamento</h3>
                            <div className="text-center text-3xl font-bold text-gray-800 mb-6">{currency(total)}</div>
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <button onClick={()=>{ finalizarVenda(total, clienteSelecionado, lojaAtiva, 'Dinheiro'); setModalPagamento(false); }} className="p-4 bg-green-100 text-green-800 rounded-xl font-bold hover:bg-green-200 flex flex-col items-center"><span>üíµ</span> Dinheiro</button>
                                <button onClick={()=>processarPagamentoCartao('Pix')} className="p-4 bg-teal-100 text-teal-800 rounded-xl font-bold hover:bg-teal-200 flex flex-col items-center"><span>üí†</span> Pix (Smart)</button>
                                <button onClick={()=>processarPagamentoCartao('D√©bito')} className="p-4 bg-blue-100 text-blue-800 rounded-xl font-bold hover:bg-blue-200 flex flex-col items-center"><span>üí≥</span> D√©bito</button>
                                <button onClick={()=>processarPagamentoCartao('Cr√©dito')} className="p-4 bg-mpBlue text-white rounded-xl font-bold hover:bg-blue-500 flex flex-col items-center shadow-lg transform hover:-translate-y-1 transition"><span>üí≥</span> Cr√©dito</button>
                            </div>
                            <button onClick={()=>setModalPagamento(false)} className="w-full py-3 bg-gray-200 text-gray-700 font-bold rounded-xl">Cancelar</button>
                        </>
                    )}

                    {mpStatus === 'processing' && (
                        <div className="text-center py-8">
                            <div className="text-6xl mb-4 animate-pulse">üì°</div>
                            <h3 className="text-xl font-bold text-mpBlue mb-2">Conectando √† Point Smart...</h3>
                            <p className="text-gray-500">{mpMessage}</p>
                            <div className="mt-6 w-full bg-gray-200 rounded-full h-2.5"><div className="bg-mpBlue h-2.5 rounded-full w-2/3 animate-pulse"></div></div>
                        </div>
                    )}

                    {mpStatus === 'success' && (
                        <div className="text-center py-8">
                            <div className="text-6xl mb-4">‚úÖ</div>
                            <h3 className="text-xl font-bold text-green-600 mb-2">Sucesso!</h3>
                            <p className="text-gray-500">Imprimindo cupom...</p>
                        </div>
                    )}

                    {mpStatus === 'error' && (
                        <div className="text-center py-8">
                            <div className="text-6xl mb-4">‚ùå</div>
                            <h3 className="text-xl font-bold text-red-600 mb-2">Erro</h3>
                            <p className="text-red-400 text-sm mb-4">{mpMessage}</p>
                            <button onClick={()=>setMpStatus('idle')} className="px-6 py-2 bg-gray-200 rounded-lg font-bold">Tentar Novamente</button>
                        </div>
                    )}

                </div>
            </div>
        )}
      </div>
    );
  }

  /* ================= FIDELIDADE VIEW (COMPLETA E REFORMULADA) ================= */
  function FidelidadeView({ clientes, setClientes }) {
      const [busca, setBusca] = useState('');
      const [modalCliente, setModalCliente] = useState(null); 
      const [modalDetalhes, setModalDetalhes] = useState(null); 
      const [abaDetalhe, setAbaDetalhe] = useState('extrato');

      const niveis = [
        { nome: 'Bronze', min: 0, cor: 'text-bronze bg-orange-100', icon: 'ü•â' },
        { nome: 'Prata', min: 100, cor: 'text-gray-500 bg-gray-100', icon: 'ü•à' },
        { nome: 'Ouro', min: 500, cor: 'text-yellow-600 bg-yellow-100', icon: 'ü•á' },
        { nome: 'Diamante', min: 1000, cor: 'text-cyan-600 bg-cyan-100', icon: 'üíé' },
      ];

      const catalogoPremios = [
        { id: 1, nome: 'Um Brigadeiro Gr√°tis', custo: 50, emoji: 'üç´' },
        { id: 2, nome: 'Desconto de R$ 10,00', custo: 100, emoji: 'üíµ' },
        { id: 3, nome: 'Caixa Presente Pequena', custo: 300, emoji: 'üéÅ' },
        { id: 4, nome: 'Cento de Doces (Festa)', custo: 800, emoji: 'üéâ' },
      ];

      const filtrados = clientes.filter(c => c.nome.toLowerCase().includes(busca.toLowerCase()) || c.telefone.includes(busca));
      
      function getNivel(total) {
        return niveis.slice().reverse().find(n => total >= n.min) || niveis[0];
      }

      function handleAddCliente(e) {
          e.preventDefault();
          const novo = { 
            id: uid(), 
            nome: e.target.nome.value, 
            telefone: e.target.tel.value, 
            saldoPontos: 0, 
            totalAcumulado: 0, 
            nivel: 'Bronze',
            historico: [{ data: new Date().toISOString(), tipo: 'entrada', valor: 0, desc: 'Cadastro inicial' }]
          };
          setClientes([...clientes, novo]);
          setModalCliente(null);
      }

      function handleManualPoints(clienteId, qtd, motivo) {
          const qtdInt = parseInt(qtd);
          if(!qtdInt) return;
          
          setClientes(clientes.map(c => {
             if(c.id === clienteId) {
                const novoSaldo = Math.max(0, c.saldoPontos + qtdInt);
                const novoAcumulado = qtdInt > 0 ? c.totalAcumulado + qtdInt : c.totalAcumulado;
                const novoNivel = getNivel(novoAcumulado).nome;
                
                const novoHist = {
                    data: new Date().toISOString(),
                    tipo: qtdInt > 0 ? 'entrada' : 'saida',
                    valor: Math.abs(qtdInt),
                    desc: motivo || 'Ajuste manual'
                };
                
                return { ...c, saldoPontos: novoSaldo, totalAcumulado: novoAcumulado, nivel: novoNivel, historico: [novoHist, ...c.historico] };
             }
             return c;
          }));
      }

      function resgatarPremio(cliente, premio) {
         if(cliente.saldoPontos < premio.custo) return alert('Saldo insuficiente!');
         if(!confirm(`Resgatar "${premio.nome}" por ${premio.custo} pontos?`)) return;

         handleManualPoints(cliente.id, -premio.custo, `Resgate: ${premio.nome}`);
         setModalDetalhes(null); // Fecha para atualizar ou poderia atualizar o estado local
         alert('Resgate realizado com sucesso! Entregue o pr√™mio.');
      }

      return (
          <div className="p-6 h-full flex flex-col">
              <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-chocolate flex items-center gap-2">üíé Clube Fidelidade Premium</h2>
                  <button onClick={() => setModalCliente(true)} className="px-6 py-3 bg-doceriaPink text-white rounded-xl font-bold shadow-lg hover:bg-pink-600 flex items-center gap-2 transition transform hover:-translate-y-1"><span>+</span> Cadastrar Cliente</button>
              </div>

              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 flex-1 flex flex-col overflow-hidden">
                  <div className="p-4 border-b bg-gray-50">
                    <input value={busca} onChange={e=>setBusca(e.target.value)} placeholder="üîç Buscar cliente por nome ou telefone..." className="w-full p-4 bg-white border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-doceriaPink shadow-sm text-lg" />
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {filtrados.map(c => {
                           const nivelObj = getNivel(c.totalAcumulado);
                           const proxNivel = niveis.find(n => n.min > c.totalAcumulado);
                           const progresso = proxNivel ? ((c.totalAcumulado - nivelObj.min) / (proxNivel.min - nivelObj.min)) * 100 : 100;

                           return (
                              <div key={c.id} className="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm hover:shadow-md transition cursor-pointer group relative overflow-hidden" onClick={() => setModalDetalhes(c)}>
                                  <div className={`absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-xs font-bold ${nivelObj.cor}`}>{nivelObj.icon} {nivelObj.nome}</div>
                                  <div className="flex items-center gap-4 mb-4">
                                      <div className="w-12 h-12 rounded-full bg-gradient-to-br from-chocolate to-gray-700 text-white flex items-center justify-center font-bold text-xl">{c.nome.charAt(0)}</div>
                                      <div>
                                          <div className="font-bold text-lg text-gray-800 leading-tight">{c.nome}</div>
                                          <div className="text-sm text-gray-500">{c.telefone}</div>
                                      </div>
                                  </div>
                                  
                                  <div className="flex justify-between items-end mb-2">
                                      <div>
                                          <div className="text-xs text-gray-400 uppercase font-bold">Saldo Dispon√≠vel</div>
                                          <div className="text-3xl font-extrabold text-doceriaPink">{c.saldoPontos}</div>
                                      </div>
                                      <div className="text-right">
                                          <div className="text-xs text-gray-400 uppercase font-bold">Total Vida</div>
                                          <div className="text-sm font-bold text-gray-600">{c.totalAcumulado} pts</div>
                                      </div>
                                  </div>

                                  <div className="w-full bg-gray-100 rounded-full h-2 mb-1 overflow-hidden">
                                      <div className="bg-green-500 h-2 rounded-full transition-all duration-1000" style={{ width: `${progresso}%` }}></div>
                                  </div>
                                  {proxNivel && <div className="text-[10px] text-gray-400 text-right">Faltam {proxNivel.min - c.totalAcumulado} pts para {proxNivel.nome}</div>}
                              </div>
                           );
                        })}
                    </div>
                  </div>
              </div>

              {/* MODAL NOVO CLIENTE */}
              {modalCliente && (
                  <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                      <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
                          <h3 className="text-xl font-bold text-chocolate mb-4">Novo Cliente Fidelidade</h3>
                          <form onSubmit={handleAddCliente} className="space-y-4">
                              <div><label className="text-xs font-bold text-gray-500">Nome Completo</label><input name="nome" required className="w-full p-3 border rounded-lg bg-gray-50" /></div>
                              <div><label className="text-xs font-bold text-gray-500">Telefone / WhatsApp</label><input name="tel" required className="w-full p-3 border rounded-lg bg-gray-50" /></div>
                              <button className="w-full py-3 bg-doceriaPink text-white rounded-xl font-bold shadow hover:bg-pink-700">Cadastrar</button>
                          </form>
                          <button onClick={() => setModalCliente(false)} className="w-full py-3 text-gray-500 mt-2 font-bold">Cancelar</button>
                      </div>
                  </div>
              )}

              {/* MODAL DETALHES CLIENTE (CRM) */}
              {modalDetalhes && (
                  <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                      <div className="bg-white rounded-3xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                          <div className="bg-chocolate p-6 text-white flex justify-between items-start">
                              <div>
                                  <h2 className="text-2xl font-bold">{modalDetalhes.nome}</h2>
                                  <p className="opacity-80">{modalDetalhes.telefone}</p>
                              </div>
                              <div className="text-right">
                                  <div className="text-sm opacity-70">Saldo de Pontos</div>
                                  <div className="text-4xl font-extrabold">{modalDetalhes.saldoPontos}</div>
                              </div>
                          </div>
                          
                          <div className="flex border-b">
                              <button onClick={()=>setAbaDetalhe('extrato')} className={`flex-1 py-4 font-bold text-sm uppercase tracking-wider ${abaDetalhe==='extrato' ? 'text-doceriaPink border-b-4 border-doceriaPink bg-pink-50' : 'text-gray-500 hover:bg-gray-50'}`}>üìú Extrato</button>
                              <button onClick={()=>setAbaDetalhe('resgate')} className={`flex-1 py-4 font-bold text-sm uppercase tracking-wider ${abaDetalhe==='resgate' ? 'text-doceriaPink border-b-4 border-doceriaPink bg-pink-50' : 'text-gray-500 hover:bg-gray-50'}`}>üéÅ Resgatar Pr√™mios</button>
                              <button onClick={()=>setAbaDetalhe('ajuste')} className={`flex-1 py-4 font-bold text-sm uppercase tracking-wider ${abaDetalhe==='ajuste' ? 'text-doceriaPink border-b-4 border-doceriaPink bg-pink-50' : 'text-gray-500 hover:bg-gray-50'}`}>‚öôÔ∏è Ajuste Manual</button>
                          </div>

                          <div className="p-6 flex-1 overflow-y-auto bg-gray-50">
                              {abaDetalhe === 'extrato' && (
                                  <div className="space-y-3">
                                      {modalDetalhes.historico && modalDetalhes.historico.length > 0 ? (
                                          modalDetalhes.historico.map((h, i) => (
                                              <div key={i} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                                  <div>
                                                      <div className="font-bold text-gray-800">{h.desc}</div>
                                                      <div className="text-xs text-gray-400">{new Date(h.data).toLocaleString()}</div>
                                                  </div>
                                                  <div className={`font-bold text-lg ${h.tipo === 'entrada' ? 'text-green-600' : 'text-red-500'}`}>
                                                      {h.tipo === 'entrada' ? '+' : '-'}{h.valor}
                                                  </div>
                                              </div>
                                          ))
                                      ) : (
                                          <div className="text-center text-gray-400 py-10">Nenhum hist√≥rico dispon√≠vel.</div>
                                      )}
                                  </div>
                              )}

                              {abaDetalhe === 'resgate' && (
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                      {catalogoPremios.map(premio => (
                                          <button key={premio.id} onClick={()=>resgatarPremio(modalDetalhes, premio)} disabled={modalDetalhes.saldoPontos < premio.custo} className="bg-white p-4 rounded-xl border hover:shadow-lg transition flex items-center gap-4 text-left disabled:opacity-50 disabled:cursor-not-allowed group">
                                              <div className="text-4xl bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center group-hover:scale-110 transition">{premio.emoji}</div>
                                              <div>
                                                  <div className="font-bold text-gray-800">{premio.nome}</div>
                                                  <div className={`font-bold text-sm ${modalDetalhes.saldoPontos >= premio.custo ? 'text-doceriaPink' : 'text-gray-400'}`}>{premio.custo} pts</div>
                                              </div>
                                          </button>
                                      ))}
                                  </div>
                              )}

                              {abaDetalhe === 'ajuste' && (
                                  <div className="bg-white p-6 rounded-xl shadow-sm border">
                                      <h4 className="font-bold text-gray-700 mb-4">Adicionar/Remover Pontos Manualmente</h4>
                                      <div className="space-y-4">
                                          <input id="ajusteQtd" type="number" placeholder="Quantidade (ex: 50 ou -50)" className="w-full p-3 border rounded-lg outline-none" />
                                          <input id="ajusteMotivo" type="text" placeholder="Motivo (ex: Esqueceu de pontuar)" className="w-full p-3 border rounded-lg outline-none" />
                                          <button onClick={() => {
                                              const qtd = document.getElementById('ajusteQtd').value;
                                              const mot = document.getElementById('ajusteMotivo').value;
                                              handleManualPoints(modalDetalhes.id, qtd, mot);
                                              setModalDetalhes(null);
                                          }} className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Confirmar Ajuste</button>
                                      </div>
                                  </div>
                              )}
                          </div>

                          <div className="p-4 bg-white border-t">
                              <button onClick={() => setModalDetalhes(null)} className="w-full py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300">Fechar</button>
                          </div>
                      </div>
                  </div>
              )}
          </div>
      );
  }

  /* ================= MAQUININHA VIEW (UPDATED v10.0 Logic) ================= */
  function MaquininhaView() {
    const [lojaAlvo, setLojaAlvo] = useState('Morada');
    const [config, setConfig] = useState({ deviceId: '', apiUrl: '' });
    
    useEffect(() => {
        const key = lojaAlvo === 'Morada' ? 'mp_config_Morada' : 'mp_config_NH';
        setConfig(storageGet(key, { deviceId: '', apiUrl: '' }));
    }, [lojaAlvo]);

    function handleSave(e) {
        e.preventDefault();
        const key = lojaAlvo === 'Morada' ? 'mp_config_Morada' : 'mp_config_NH';
        storageSet(key, config);
        alert(`Configura√ß√£o Salva para ${lojaAlvo}!`);
    }

    return (
      <div className="p-6 h-full flex flex-col pb-20">
        <h2 className="text-3xl font-extrabold text-mpBlue border-b pb-2 mb-6 flex items-center gap-3">‚òÅÔ∏è Integra√ß√£o Point Smart</h2>
        <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 max-w-2xl mx-auto w-full">
            <div className="flex gap-4 mb-6">
                <button onClick={()=>setLojaAlvo('Morada')} className={`flex-1 p-3 rounded-lg font-bold border-2 ${lojaAlvo==='Morada' ? 'border-mpBlue bg-blue-50 text-mpBlue' : 'border-gray-200'}`}>Loja Morada</button>
                <button onClick={()=>setLojaAlvo('Novo Horizonte')} className={`flex-1 p-3 rounded-lg font-bold border-2 ${lojaAlvo==='Novo Horizonte' ? 'border-mpBlue bg-blue-50 text-mpBlue' : 'border-gray-200'}`}>Loja NH</button>
            </div>
            
            <form onSubmit={handleSave} className="space-y-4">
                <div className="p-4 bg-blue-50 rounded-lg text-sm text-blue-800 border border-blue-200 mb-4">
                    <strong>Como configurar:</strong><br/>
                    1. Device ID: Olhe atr√°s da maquininha (Serial Number).<br/>
                    2. API URL: Link da sua Edge Function no Supabase.
                </div>
                
                <div>
                    <label className="text-xs font-bold text-gray-500 uppercase">Device ID (Serial)</label>
                    <input required value={config.deviceId} onChange={e=>setConfig({...config, deviceId: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-lg font-mono" placeholder="Ex: 8880000123456" />
                </div>
                <div>
                    <label className="text-xs font-bold text-gray-500 uppercase">URL da API (Supabase)</label>
                    <input required value={config.apiUrl} onChange={e=>setConfig({...config, apiUrl: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-lg font-mono" placeholder="https://seu-projeto.supabase.co/functions/v1/pagamento-mp" />
                </div>
                <button className="w-full py-4 bg-mpBlue text-white rounded-xl font-bold shadow hover:bg-blue-600 transition">üíæ Salvar Conex√£o</button>
            </form>
        </div>
      </div>
    );
  }
  
  /* ================= NOVA TELA DE RELAT√ìRIOS CONT√ÅBEIS (CORRIGIDA) ================= */
  function RelatoriosView({ vendas }) {
      const [dataInicio, setDataInicio] = useState(new Date().toISOString().slice(0,10));
      const [dataFim, setDataFim] = useState(new Date().toISOString().slice(0,10));
      
      const vendasPeriodo = useMemo(() => {
          // CORRE√á√ÉO: For√ßar datas para cobrir o dia inteiro localmente
          const inicio = new Date(dataInicio + 'T00:00:00');
          const fim = new Date(dataFim + 'T23:59:59');
          return vendas.filter(v => { const d = new Date(v.data); return d >= inicio && d <= fim; });
      }, [vendas, dataInicio, dataFim]);

      const totalBruto = vendasPeriodo.reduce((a,b) => a + b.total, 0);
      const totalCusto = vendasPeriodo.reduce((acc, v) => acc + v.itens.reduce((iAcc, item) => iAcc + ((item.custo||0)*item.quantidade), 0), 0);
      const lucroLiquido = totalBruto - totalCusto;
      const estimativaImposto = totalBruto * 0.06; // Exemplo Simples Nacional 6%

      return (
          <div className="p-6 pb-20">
              <h2 className="text-2xl font-bold text-chocolate mb-6 flex items-center gap-2"><span className="text-3xl">üìÅ</span> Contabilidade & Fiscal</h2>
              
              <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 mb-8">
                  <h3 className="text-lg font-bold text-gray-700 mb-4">Filtrar Per√≠odo</h3>
                  <div className="flex flex-col md:flex-row gap-4 items-end">
                      <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data In√≠cio</label><input type="date" value={dataInicio} onChange={e=>setDataInicio(e.target.value)} className="p-3 border rounded-xl bg-gray-50 font-bold text-gray-700" /></div>
                      <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data Fim</label><input type="date" value={dataFim} onChange={e=>setDataFim(e.target.value)} className="p-3 border rounded-xl bg-gray-50 font-bold text-gray-700" /></div>
                      <div className="flex-1"></div>
                      <button onClick={() => gerarCSVContabil(vendas, dataInicio, dataFim)} className="w-full md:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow hover:bg-green-700 flex items-center justify-center gap-2">üìÑ Baixar Relat√≥rio CSV (Excel)</button>
                  </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                  <div className="bg-white p-4 rounded-xl shadow border border-l-4 border-l-blue-500">
                      <div className="text-xs font-bold text-gray-500 uppercase">Faturamento Bruto</div>
                      <div className="text-2xl font-bold text-blue-600">{currency(totalBruto)}</div>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow border border-l-4 border-l-red-500">
                      <div className="text-xs font-bold text-gray-500 uppercase">Custo Produtos</div>
                      <div className="text-2xl font-bold text-red-500">{currency(totalCusto)}</div>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow border border-l-4 border-l-green-500">
                      <div className="text-xs font-bold text-gray-500 uppercase">Lucro Bruto</div>
                      <div className="text-2xl font-bold text-green-600">{currency(lucroLiquido)}</div>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow border border-l-4 border-l-orange-500">
                      <div className="text-xs font-bold text-gray-500 uppercase">Est. Imposto (6%)</div>
                      <div className="text-2xl font-bold text-orange-500">{currency(estimativaImposto)}</div>
                  </div>
              </div>

              <div className="bg-white rounded-xl shadow border border-gray-100 overflow-hidden">
                  <div className="p-4 bg-gray-50 border-b font-bold text-gray-600">Pr√©via dos Dados ({vendasPeriodo.length} registros)</div>
                  <div className="overflow-x-auto">
                      <table className="w-full text-sm text-left">
                          <thead className="bg-gray-100 text-gray-600 uppercase text-xs">
                              <tr>
                                  <th className="p-3">Data/Hora</th>
                                  <th className="p-3">Loja</th>
                                  <th className="p-3">M√©todo</th>
                                  <th className="p-3 text-right">Valor</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y">
                              {vendasPeriodo.slice(0, 10).map(v => (
                                  <tr key={v.id}>
                                      <td className="p-3">{new Date(v.data).toLocaleString()}</td>
                                      <td className="p-3">{v.loja}</td>
                                      <td className="p-3">{v.metodo}</td>
                                      <td className="p-3 text-right font-bold">{currency(v.total)}</td>
                                  </tr>
                              ))}
                              {vendasPeriodo.length === 0 && <tr><td colSpan="4" className="p-3 text-center text-gray-500">Nenhuma venda neste per√≠odo.</td></tr>}
                              {vendasPeriodo.length > 10 && <tr><td colSpan="4" className="p-3 text-center text-gray-500 italic">...e mais {vendasPeriodo.length - 10} vendas</td></tr>}
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      )
  }

  function Sidebar({selected, setSelected, user}){
    // MENU REDUZIDO PARA FUNCION√ÅRIO (NA MAQUININHA)
    const menuCaixa = [
      { id:'pdv', icon:'üõí', label:'Caixa / Venda' },
      { id:'produtos', icon:'üç©', label:'Consultar Pre√ßos' }, // Apenas consulta
      { id:'fidelidade', icon:'üíé', label:'Fidelidade' },
    ];

    // MENU COMPLETO PARA O DONO (ADMIN)
    const menuAdmin = [
      { id:'dashboard', icon:'üç∞', label:'Painel Geral' },
      { id:'pdv', icon:'üõí', label:'Caixa / Venda' },
      { id:'produtos', icon:'üç©', label:'Meus Doces' },
      { id:'fidelidade', icon:'üíé', label:'Clube Fidelidade' },
      { id:'bi', icon:'üìà', label:'BI & Analytics' },
      { id:'maquininha', icon:'üí≥', label:'Config. Maquininha' },
      { id:'relatorios', icon:'üìÇ', label:'Contabilidade' },
    ];

    // Define qual menu mostrar baseado no login
    const menu = user.role === 'admin' ? menuAdmin : menuCaixa;

    return (
      <aside className="w-64 bg-chocolate text-white hidden md:flex flex-col shadow-xl z-20 h-full">
        <div className="p-6 flex flex-col items-center border-b border-white/10">
            <div className="text-4xl mb-2">üßÅ</div>
            <div className="font-bold tracking-widest text-doceriaCream">WAGNER DOCES</div>
            <div className="text-xs bg-white/20 px-2 py-1 rounded mt-2 uppercase font-bold text-xs tracking-wider">{user.store === 'Todas' ? 'Admin Master' : `Loja ${user.store}`}</div>
        </div>
        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
          {menu.map(i=>(
            <button key={i.id} onClick={()=>setSelected(i.id)} className={`flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all ${selected===i.id ? 'bg-doceriaPink text-white shadow-lg font-bold' : 'text-doceriaCream/70 hover:bg-white/10 hover:text-white'}`}>
              <span className="text-xl">{i.icon}</span><span>{i.label}</span>
            </button>
          ))}
        </nav>
      </aside>
    );
  }

  function Header({user, onLogout}){
    return (
      <header className="bg-white shadow-sm h-16 flex flex-shrink-0 items-center justify-between px-6 border-b border-chocolate/10 relative z-30">
        <div className="flex items-center gap-4"><h1 className="text-xl font-bold text-chocolate tracking-tight">WAGNER Doces <span className="text-doceriaPink">PDV</span></h1></div>
        <div className="flex items-center gap-6 text-sm">
            <div className="flex items-center gap-2 text-gray-600"><span>üë§ {user.username}</span></div>
            <button onClick={onLogout} className="text-red-500 hover:text-red-700 font-medium">Sair</button>
        </div>
      </header>
    );
  }

  function ProdutosView({ produtos, onAdd, onEdit, onDelete, user }) {
      const [adding, setAdding] = useState(false);
      const [editingProduct, setEditingProduct] = useState(null);

      // VERIFICA SE √â O DONO
      const isAdmin = user && user.role === 'admin';

      const getEstoque = (p, loja) => (p.estoque && p.estoque[loja] !== undefined) ? p.estoque[loja] : 0;

      return (
          <div className="p-6 pb-20">
              <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-chocolate">
                      {isAdmin ? 'Gerenciar Produtos & Estoque' : 'Consultar Pre√ßos'}
                  </h2>
                  
                  {/* S√ì O ADMIN V√ä O BOT√ÉO DE ADICIONAR */}
                  {isAdmin && (
                      <button onClick={()=>setAdding(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg font-bold shadow hover:bg-green-700 flex items-center gap-2">
                          + Novo Produto
                      </button>
                  )}
              </div>

              <div className="bg-white rounded-xl shadow overflow-hidden border border-gray-100">
                  <table className="w-full text-sm">
                      <thead className="bg-chocolate text-white">
                        <tr>
                            <th className="p-4 text-left">Produto</th>
                            <th className="p-4 text-right">Pre√ßo</th>
                            {/* CAIXA N√ÉO PRECISA VER ALERTA M√çNIMO, S√ì ESTOQUE ATUAL */}
                            {isAdmin && <th className="p-4 text-center">Alerta Min.</th>}
                            
                            <th className="p-4 text-center bg-doceriaPink/20">Est. MORADA</th>
                            <th className="p-4 text-center bg-blue-600/20">Est. NH</th>
                            
                            {/* S√ì MOSTRA COLUNA A√á√ïES PARA O ADMIN */}
                            {isAdmin && <th className="p-4 text-center">A√ß√µes</th>}
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-100">
                          {produtos.map(p => (
                            <tr key={p.id} className="hover:bg-orange-50">
                                <td className="p-4 font-bold text-gray-700 flex items-center gap-2">
                                    <span className="text-xl">{p.emoji}</span> {p.nome}
                                </td>
                                <td className="p-4 text-right font-bold text-chocolate">{currency(p.preco)}</td>
                                
                                {isAdmin && <td className="p-4 text-center text-gray-500 font-mono">{p.limiteAlerta || 15}</td>}
                                
                                <td className="p-4 text-center bg-pink-50 font-bold text-doceriaPink">{getEstoque(p,'morada')}</td>
                                <td className="p-4 text-center bg-blue-50 font-bold text-blue-600">{getEstoque(p,'novoHorizonte')}</td>
                                
                                {/* BOT√ïES DE EDI√á√ÉO SOMEM PARA O CAIXA */}
                                {isAdmin && (
                                    <td className="p-4 text-center flex gap-2 justify-center">
                                        <button onClick={()=>setEditingProduct(p)} className="text-blue-500 font-bold hover:bg-blue-100 p-2 rounded">‚úèÔ∏è</button>
                                        <button onClick={()=>onDelete(p.id)} className="text-red-500 font-bold hover:bg-red-100 p-2 rounded">üóëÔ∏è</button>
                                    </td>
                                )}
                            </tr>
                          ))}
                      </tbody>
                  </table>
              </div>
              
              {/* MODAIS S√ì ABREM SE FOR ADMIN (SEGURAN√áA EXTRA) */}
              {adding && isAdmin && <ModalProduto onClose={()=>setAdding(false)} onSave={(p)=>{ onAdd(p); setAdding(false); }} />}
              {editingProduct && isAdmin && <ModalProduto productToEdit={editingProduct} onClose={()=>setEditingProduct(null)} onSave={(p)=>{ onEdit(p); setEditingProduct(null); }} />}
          </div>
      )
  }

  function ModalProduto({ onClose, onSave, productToEdit }) {
    const isEditing = !!productToEdit;
    const [form, setForm] = useState({ 
        nome: '', preco: '', custo: '', categoria: 'Geral', emoji: 'üç¨', limiteAlerta: 15, estoque: { morada: 0, novoHorizonte: 0 } 
    });
    const [em, setEm] = useState(0); 
    const [enh, setEnh] = useState(0);
    
    useEffect(() => {
        if (productToEdit) {
            setForm({
                ...productToEdit,
                preco: productToEdit.preco,
                custo: productToEdit.custo || 0,
                emoji: productToEdit.emoji || 'üç¨'
            });
            setEm(productToEdit.estoque ? productToEdit.estoque.morada : 0);
            setEnh(productToEdit.estoque ? productToEdit.estoque.novoHorizonte : 0);
        }
    }, [productToEdit]);

    function save(e){ 
        e.preventDefault(); 
        onSave({
            ...form, 
            id: isEditing ? productToEdit.id : uid(), 
            preco: parseFloat(form.preco), 
            limiteAlerta: parseInt(form.limiteAlerta) || 15,
            estoque: { morada: parseInt(em), novoHorizonte: parseInt(enh) }
        }); 
    }

    return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
            <form onSubmit={save} className="bg-white p-6 rounded-xl w-full max-w-sm space-y-3">
                <h3 className="font-bold text-chocolate text-lg mb-2">{isEditing ? 'Editar Produto' : 'Novo Produto'}</h3>
                
                <div className="grid grid-cols-4 gap-2">
                    <div className="col-span-1">
                          <label className="text-xs font-bold text-gray-500">√çcone</label>
                          <input className="w-full p-2 border rounded text-center text-xl" value={form.emoji} onChange={e=>setForm({...form, emoji: e.target.value})} />
                    </div>
                    <div className="col-span-3">
                          <label className="text-xs font-bold text-gray-500">Nome</label>
                          <input placeholder="Nome" required value={form.nome} className="w-full p-2 border rounded" onChange={e=>setForm({...form, nome: e.target.value})} />
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-2">
                    <div>
                        <label className="text-xs font-bold text-gray-500">Pre√ßo Venda</label>
                        <input placeholder="Pre√ßo" type="number" step="0.01" value={form.preco} required className="w-full p-2 border rounded" onChange={e=>setForm({...form, preco: e.target.value})} />
                    </div>
                    <div>
                        <label className="text-xs font-bold text-gray-500">Custo</label>
                        <input placeholder="Custo" type="number" step="0.01" value={form.custo} className="w-full p-2 border rounded" onChange={e=>setForm({...form, custo: e.target.value})} />
                    </div>
                </div>
                <div>
                      <label className="text-xs font-bold text-gray-500">Alerta Estoque M√≠nimo</label>
                      <input type="number" value={form.limiteAlerta} className="w-full p-2 border rounded" onChange={e=>setForm({...form, limiteAlerta: e.target.value})} />
                </div>
                
                <div className="grid grid-cols-2 gap-2 pt-2 border-t mt-2">
                    <div className="bg-pink-50 p-2 rounded">
                        <label className="text-xs font-bold text-doceriaPink block mb-1">Est. Morada</label>
                        <input type="number" value={em} className="w-full p-2 border border-doceriaPink rounded font-bold text-center" onChange={e=>setEm(e.target.value)} />
                    </div>
                    <div className="bg-blue-50 p-2 rounded">
                        <label className="text-xs font-bold text-blue-600 block mb-1">Est. N. Horiz</label>
                        <input type="number" value={enh} className="w-full p-2 border border-blue-500 rounded font-bold text-center" onChange={e=>setEnh(e.target.value)} />
                    </div>
                </div>

                <button className="w-full py-3 bg-doceriaPink text-white font-bold rounded mt-4">{isEditing ? 'Salvar Altera√ß√µes' : 'Criar Produto'}</button>
                <button type="button" onClick={onClose} className="w-full py-2 text-gray-500">Cancelar</button>
            </form>
        </div>
    )
  }

  function ModalCupom({ venda, onClose }) {
    if(!venda) return null;
    return (
      <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-lg shadow-2xl w-full max-w-sm overflow-hidden">
            <div id="cupom-imprecao" className="p-6 bg-[#fffdf0] font-mono text-xs text-gray-900 tracking-tighter leading-tight shadow-inner">
                <div className="text-center border-b border-dashed border-gray-800 pb-2 mb-2">
                    <h2 className="font-bold text-lg uppercase tracking-normal">WAGNER Doces</h2>
                    <p className="font-bold">{venda.loja}</p>
                    <p className="text-[10px]">CUPOM N√ÉO FISCAL</p>
                </div>
                <div className="mb-2 text-[10px]"><p>Data: {new Date(venda.data).toLocaleString()}</p><p>ID: {venda.id}</p></div>
                <table className="w-full text-[10px] mb-2">
                    <thead><tr className="border-b border-dashed border-gray-800"><th className="text-left py-1">Qtd Item</th><th className="text-right py-1">Total</th></tr></thead>
                    <tbody>{venda.itens.map((item, idx) => (<tr key={idx}><td className="py-1">{item.quantidade}x {item.nome}</td><td className="text-right py-1">{currency(item.preco * item.quantidade)}</td></tr>))}</tbody>
                </table>
                <div className="border-t border-dashed border-gray-800 pt-2 flex justify-between items-center text-sm"><span>TOTAL R$</span><span className="font-bold text-lg">{Number(venda.total).toFixed(2).replace('.',',')}</span></div>
                <div className="mt-2 text-center font-bold text-xs border p-1 rounded border-gray-400">PAGAMENTO: {venda.metodo.toUpperCase()}</div>
                <div className="text-center mt-4 text-[10px] uppercase"><p>Obrigado pela prefer√™ncia!</p></div>
            </div>
            <div className="flex p-4 gap-2 bg-gray-100 border-t"><button onClick={onClose} className="flex-1 py-2 bg-gray-300 rounded font-bold">Fechar</button><button onClick={()=>window.print()} className="flex-1 py-2 bg-chocolate text-white rounded font-bold">üñ®Ô∏è Imprimir</button></div>
        </div>
      </div>
    );
  }

  function Login({onLogin}){
    const [u, setU] = useState('');
    const [p, setP] = useState('');
    const [erro, setErro] = useState('');

    function submit(e){ 
      e.preventDefault(); 
      setErro('');

      // --- L√ìGICA DE ACESSO (QUEM √â QUEM) ---
      if(u === 'admin' && p === '1234') {
          // DONO: V√™ tudo, pode trocar de loja
          onLogin({ username: 'Wagner (Admin)', role: 'admin', store: 'Todas' });
      } 
      else if (u === 'morada' && p === '1111') {
          // MAQUININHA 1: Travada em Morada, s√≥ vende
          onLogin({ username: 'Caixa Morada', role: 'caixa', store: 'Morada' });
      }
      else if (u === 'nh' && p === '2222') {
          // MAQUININHA 2: Travada em Novo Horizonte, s√≥ vende
          onLogin({ username: 'Caixa NH', role: 'caixa', store: 'Novo Horizonte' });
      }
      else {
          setErro('Usu√°rio ou senha incorretos.');
      }
    }

    return (
      <div className="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-chocolate via-dark to-chocolate">
        <div className="bg-white rounded-3xl p-8 shadow-2xl max-w-md w-full border-4 border-doceriaCream">
            <h1 className="text-2xl font-extrabold text-chocolate text-center mb-1">WAGNER DOCES</h1>
            <p className="text-center text-gray-400 text-sm mb-6">Sistema Integrado Android</p>
            
            <form onSubmit={submit} className="space-y-4">
              <div>
                  <label className="text-xs font-bold text-gray-500 ml-1">Usu√°rio</label>
                  <input className="w-full p-3 border border-chocolateLight rounded-xl outline-none" placeholder="ex: admin, morada, nh" value={u} onChange={e=>setU(e.target.value)} />
              </div>
              <div>
                  <label className="text-xs font-bold text-gray-500 ml-1">Senha</label>
                  <input type="password" className="w-full p-3 border border-chocolateLight rounded-xl outline-none" placeholder="Senha" value={p} onChange={e=>setP(e.target.value)} />
              </div>
              
              {erro && <div className="text-red-500 text-sm font-bold text-center bg-red-100 p-2 rounded">{erro}</div>}
              
              <button className="w-full py-3 bg-doceriaPink text-white rounded-xl font-bold shadow-lg hover:bg-pink-700 transition transform active:scale-95">ACESSAR SISTEMA</button>
            </form>
            
            <div className="mt-6 text-center text-xs text-gray-400 bg-gray-50 p-2 rounded">
                <p><strong>Admin:</strong> admin / 1234</p>
                <p><strong>Loja 1:</strong> morada / 1111</p>
                <p><strong>Loja 2:</strong> nh / 2222</p>
            </div>
        </div>
      </div>
    );
  }

  function App(){
    const [user, setUser] = useState(null);
    const [page, setPage] = useState('pdv');
    const [produtos, setProdutos] = useState([]);
    const [clientes, setClientes] = useState([]); 
    const [carrinho, setCarrinho] = useState([]);
    const [vendas, setVendas] = useState([]);
    const [cupomVenda, setCupomVenda] = useState(null);

    // Carregamento de dados
    useEffect(() => {
        const prods = storageGet('produtos', initialProducts);
        const prodsFixed = prods.map(p => {
             const base = { ...p };
             if(typeof p.estoque === 'number') base.estoque = { morada: p.estoque, novoHorizonte: 0 };
             if(!p.limiteAlerta) base.limiteAlerta = 15;
             return base;
        });
        setProdutos(prodsFixed);
        setClientes(storageGet('clientes', initialClients)); 
        setVendas(storageGet('vendas', []));
    }, []);

    // Salvamento autom√°tico
    useEffect(() => { if(produtos.length > 0) storageSet('produtos', produtos); }, [produtos]);
    useEffect(() => { if(vendas.length > 0) storageSet('vendas', vendas); }, [vendas]);
    useEffect(() => { if(clientes.length > 0) storageSet('clientes', clientes); }, [clientes]);

    function handleAddProduct(prod) { setProdutos([...produtos, prod]); }
    function handleEditProduct(prod) { setProdutos(produtos.map(p => p.id === prod.id ? prod : p)); }
    function handleDeleteProduct(id) { if(confirm("Excluir?")) setProdutos(produtos.filter(p => p.id !== id)); }

    // LOGIN INTELIGENTE
    function handleLogin(userData) {
        setUser(userData);
        // Se for Admin, vai pro Dashboard. Se for Caixa, vai direto pra Venda.
        if(userData.role === 'admin') setPage('dashboard');
        else setPage('pdv');
    }

    function handleFinalizarVenda(total, clienteId, loja, metodo) {
        // Atualiza Estoque na loja espec√≠fica
        const novosProdutos = produtos.map(prod => {
            const itemCarrinho = carrinho.find(c => c.id === prod.id);
            if(itemCarrinho) {
                const novoEstoque = { ...prod.estoque };
                if(loja === 'Morada') novoEstoque.morada -= itemCarrinho.quantidade;
                else novoEstoque.novoHorizonte -= itemCarrinho.quantidade;
                return { ...prod, estoque: novoEstoque };
            }
            return prod;
        });

        // Atualiza Cliente (Fidelidade)
        if(clienteId) {
             const pts = Math.floor(total);
             setClientes(clientes.map(c => {
                 if(c.id == clienteId) {
                     const novoSaldo = (c.saldoPontos || 0) + pts;
                     const novoAcumulado = (c.totalAcumulado || 0) + pts;
                     
                     let novoNivel = 'Bronze';
                     if(novoAcumulado >= 1000) novoNivel = 'Diamante';
                     else if(novoAcumulado >= 500) novoNivel = 'Ouro';
                     else if(novoAcumulado >= 100) novoNivel = 'Prata';

                     const historicoItem = {
                         data: new Date().toISOString(),
                         tipo: 'entrada',
                         valor: pts,
                         desc: `Compra na loja ${loja}`
                     };

                     return { 
                         ...c, 
                         saldoPontos: novoSaldo, 
                         totalAcumulado: novoAcumulado,
                         nivel: novoNivel,
                         historico: [historicoItem, ...(c.historico || [])]
                     };
                 }
                 return c;
             }));
        }

        const itensComCusto = carrinho.map(i => ({...i, custo: i.custo || 0}));

        const novaVenda = { 
            id: uid(), data: new Date().toISOString(), itens: itensComCusto, total: total, 
            custoVenda: 0, metodo: metodo, clienteId: clienteId, loja: loja 
        };
        
        setProdutos(novosProdutos);
        setVendas([...vendas, novaVenda]);
        setCarrinho([]);
        setCupomVenda(novaVenda);
    }

    if(!user) return <Login onLogin={handleLogin} />;

    return (
      <div className="app-container">
        <Sidebar selected={page} setSelected={setPage} user={user} />
        
        <div className="main-content-area">
          <Header user={user} onLogout={()=>setUser(null)} />
          
          <div className="scrollable-content bg-doceriaCream/30">
            {/* ADMIN V√ä TUDO */}
            {page === 'dashboard' && user.role === 'admin' && <DashboardView vendas={vendas} produtos={produtos} />}
            {page === 'bi' && user.role === 'admin' && <BIView vendas={vendas} produtos={produtos} />}
            {page === 'relatorios' && user.role === 'admin' && <RelatoriosView vendas={vendas} />}
            {page === 'maquininha' && user.role === 'admin' && <MaquininhaView />}
            
            {/* CAIXA S√ì V√ä ISSO (E TRAVA A LOJA NO PDV) */}
            {page === 'pdv' && (
                <PDVView 
                    produtos={produtos} 
                    carrinho={carrinho} 
                    setCarrinho={setCarrinho} 
                    finalizarVenda={handleFinalizarVenda} 
                    clientes={clientes} 
                    user={user} 
                />
            )}
            
            {page === 'fidelidade' && <FidelidadeView clientes={clientes} setClientes={setClientes} />}
            
            {/* Produtos: Admin edita, Caixa s√≥ visualiza (passamos o USER) */}
            {page === 'produtos' && (
                <ProdutosView 
                    produtos={produtos} 
                    onAdd={handleAddProduct} 
                    onEdit={handleEditProduct} 
                    onDelete={handleDeleteProduct} 
                    user={user} 
                />
            )}
          </div>
        </div>
        
        {cupomVenda && <ModalCupom venda={cupomVenda} onClose={()=>setCupomVenda(null)} />}
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
  </script>
</body>
</html>

